<!DOCTYPE HTML>

<html>

<head>
	<script type="text/javascript" src="http://maps.googleapis.com/maps/api/js?sensor=true"></script>
	<meta charset = "utf-8" />
	<title>Landmarks</title>
	<script>
		var myLat = 0;
		var myLng = 0;
		var xmlReq = new XMLHttpRequest();
		var me = new google.maps.LatLng(myLat, myLng);
		var raw = "";
		var locationData;
		var personMarkers = {};
		var landMarkers = {};
		var landMarkers
		var myOptions = {
			zoom: 15, // The larger the zoom number, the bigger the zoom
			center: me,
			mapTypeId: google.maps.MapTypeId.ROADMAP
		};
		var map;
		var marker;
		var infowindow = new google.maps.InfoWindow();
		var personIndex = 0;
		var landIndex = 0;

		function init()
		{
			map = new google.maps.Map(document.getElementById("map_canvas"), myOptions);
			getMyLocation();
		}
			
		function getMyLocation() {
			if (navigator.geolocation) { // the navigator.geolocation object is supported on your browser
				navigator.geolocation.getCurrentPosition(function(position) {
					myLat = position.coords.latitude;
					myLng = position.coords.longitude;
					renderMap();
					sendLocation(myLat, myLng);
				});
			}
			else {
				alert("Geolocation is not supported by your web browser.  What a shame!");
			}
		}

		function sendLocation (myLat, myLng) {
			xmlReq.open("POST", "https://defense-in-derpth.herokuapp.com/sendLocation",true);
			xmlReq.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
			xmlReq.onreadystatechange = function() {
    			if(xmlReq.readyState == 4 && xmlReq.status == 200) {
        			raw = xmlReq.responseText;
        			locationData = JSON.parse(raw);
        			addMarkers();
    			}
			}
			xmlReq.send("login=ELOISE_DELACRUZ&lat="+myLat+"&lng="+myLng);

		}

		function renderMap()
		{
			me = new google.maps.LatLng(myLat, myLng);
			
			// Update map and go there...
			map.panTo(me);
	
			// Create a marker
			marker = new google.maps.Marker({
				position: me,
				title: "Here I Am!"
			});
			marker.setMap(map);
					
			// Open info window on click of marker
			google.maps.event.addListener(marker, 'click', function() {
				infowindow.setContent(marker.title);
				infowindow.open(map, marker);
			});
		}

		function addMarkers() {
			for (i = 0; i < locationData.people.length; i++){
				markPerson(locationData.people[i]);
			}
			for (i = 0; i < locationData.landmarks.length; i++) {
				markLandmark(locationData.landmarks[i]);
			}
		}

		function markPerson (person) {
			var personIcon = {
				url: "./images/stick_figure.jpg",
				scaledSize: new google.maps.Size(50,50)
			};
			personMarkers[personIndex] = new google.maps.Marker({
				position: new google.maps.LatLng(person.lat, person.lng),
				title: person.login,
				icon: personIcon
			});
			personMarkers[personIndex].setMap(map);
			google.maps.event.addListener(personMarkers[personIndex], 'click', function(e) {
				i = search(personMarkers, personIndex, e.latLng);
				infowindow.setContent(personMarkers[i].title);
				infowindow.open(map,personMarkers[i]);
			});
			personIndex++;
		}

		function markLandmark (landmark) {
			var landmarkIcon = {
				url: "./images/house.png",
				scaledSize: new google.maps.Size(50,50)
			};
			landMarkers[landIndex] = new google.maps.Marker({
					position: new google.maps.LatLng(landmark.geometry.coordinates[0], landmark.geometry.coordinates[1]),
					title: landmark.properties.Location_Name,
					icon: landmarkIcon
			});
			landMarkers[landIndex].setMap(map);
			google.maps.event.addListener(landMarkers[landIndex], 'click', function(e) {
				i = search(landMarkers, landIndex, e.latLng);
				infowindow.setContent(locationData.landmarks[i].properties.Details);
				infowindow.open(map, landMarkers[i]);
			});
			landIndex++;
		}

		function search (list, len, ltlg) {
			for (i = 0; i < len; i++) {
				if (list[i].position.equals(ltlg)){
					return i;
				}
			}
			return 0;
		}
	</script>
	<link rel = "stylesheet" href = "style.css" type = "text/css" />
</head>

<body onload = "init()">
	<div id="map_canvas"></div>
</body>

</html>